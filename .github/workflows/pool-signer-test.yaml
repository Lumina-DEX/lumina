name: Pool Signer Test

on:
  pull_request:
    branches: ["main"]
    paths:
      - "packages/signer/**"
      - ".github/workflows/pool-signer-test.yaml"
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  deployments: write

jobs:
  test-signer:
    name: Test Pool Signer
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: signer
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d signer"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/signer
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🛠️ Setup Moon toolchain
        uses: "moonrepo/setup-toolchain@v0"

      - name: 🗃️ DB migrate & seed
        run: moon signer:db-migrate && moon signer:db-seed

      - name: 🧪 Run integration tests
        run: moon signer:test-integration -u
        env:
          INFISICAL_ENVIRONMENT: dev
          INFISICAL_PROJECT_ID: 1cae9006-c83d-415d-b207-c966c9d1df48
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}

      - name: 📊 Upload Moon report
        uses: "moonrepo/run-report-action@v1"
        if: success() || failure()
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
