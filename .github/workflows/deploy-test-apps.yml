name: Deploy Test Apps Workflow

on:
  workflow_call:
  workflow_dispatch:

concurrency: wc-${{ github.workflow }}-${{ github.ref }}
permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  deploy-test-apps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - uses: "moonrepo/setup-toolchain@v0"
        with:
          auto-install: true
          auto-setup: true

      - name: Deploy Test Vue website
        run: moon sdk-test-vue:deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Test React website
        run: moon sdk-test-react:deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Comment on commit
        uses: actions/github-script@v7
        with:
          script: |
            const url1 = "https://lumina-sdk-vue-test.pages.dev/"
            const url2 = "https://lumina-sdk-react-test.pages.dev/"
            const body =
              `### 🛸 Vue SDK Test Webapp Deployed! 🏌️‍♀️
              |  | URL |
              | --- | --- |
              | 🔮 Vue | ${url1} |
              | 🔮 React | ${url2} |

              > Deployed by Wrangler`
            const { sha, repo: { owner , repo }} = context
            const commitComment = await github.rest.repos.createCommitComment({ commit_sha: sha, owner, repo, body })
            console.log({ commitComment })
