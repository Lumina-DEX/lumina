name: Deploy CDN

on:
  push:
    branches: ["main"]
    paths:
      - "packages/contracts-cdn/**"
      - ".github/workflows/cdn.yaml"
  workflow_dispatch:
  workflow_call:

# Prevent concurrent deployments on the same branch
concurrency: wc-${{ github.workflow }}-${{ github.ref }}

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  deployments: write

jobs:
  deploy-cdn:
    name: Deploy CDN
    runs-on: ubuntu-latest

    outputs:
      # Used by downstream jobs (e.g. e2e tests)
      url: ${{ steps.cloudflare.outputs.deployment-url }}

    steps:
      # Checkout the repository
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Moon + toolchain (pnpm, node, bun, etc.)
      - name: ğŸ› ï¸ Setup Moon toolchain
        uses: moonrepo/setup-toolchain@v0

      # Run tests (currently a no-op due to vitest + containers limitation)
      - name: ğŸ§ª Run contracts-cdn tests
        run: moon contracts-cdn:test

      # Build the Mina proving key cache and public CDN assets
      # This generates:
      # - cache/
      # - public/cdn-cgi/assets/**
      - name: ğŸ—‚ï¸ Build contracts-cdn cache
        run: moon contracts-cdn:build-cache

      # Build the Worker bundle (tsdown -> output/index.js)
      # Important: Wrangler must deploy a prebuilt JS file
      - name: ğŸ—ï¸ Build Worker bundle
        run: moon contracts-cdn:container-build

        # Free disk space before Docker build
      - name: ğŸ§¹ Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      # Deploy the Worker + static assets to Cloudflare
      # This step must NOT trigger a full monorepo build
      - name: ğŸš€ Deploy to Cloudflare Workers
        id: cloudflare
        uses: ./.github/workflows/actions/deploy-cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          task: contracts-cdn:deploy

      # Comment on the commit with the deployment URL and logs
      - name: ğŸ’¬ Comment on commit
        uses: actions/github-script@v7
        env:
          COMMAND_OUTPUT: ${{ steps.cloudflare.outputs.command-output }}
        with:
          result-encoding: string
          script: |
            const url = "${{ steps.cloudflare.outputs.deployment-url }}"
            const output = process.env.COMMAND_OUTPUT

            const body = `
            ### ğŸ›¸ LuminaDex CDN is live

            #### ğŸŒ Deploy URL
            ${url ? `[Cloudflare Workers preview](${url})` : "_No URL detected_"}

            #### ğŸ” Build Output
            <details><summary>Logs</summary><pre>${output}</pre></details>

            > Deployed via GitHub Actions
            `

            const { sha, repo: { owner , repo }} = context
            const commitComment = await github.rest.repos.createCommitComment({ commit_sha: sha, owner, repo, body })
            console.log({ commitComment })
