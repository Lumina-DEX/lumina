# yaml-language-server: $schema=../../.moon/cache/schemas/project.json

layer: application

dependsOn:
  - contracts
  - sdk

fileGroups:
  container:
    - container/**/*
  sources:
    - src/**/*
    - scripts/**/*
    - drizzle/**/*
    - public/**/*
    - drizzle.config.ts
    - package.json
    - tsconfig.json
    - worker-configuration.d.ts
  tests:
    - test/**/*
    - vitest.config.mts

tasks:
  dev:
    command: wrangler dev
    deps: ["^:build"]
    preset: "server"
  test:
    description: "TODO: https://github.com/cloudflare/workers-sdk/issues/10408"
    script: echo 'Tests are disabled due to a vitest + container bug' && exit 0
  pooldb-typegen:
    command: pnpx supabase gen types typescript --project-id dqofogasktmvjqcjaeyk > @out(0) --debug
    outputs:
      - src/pooldb.types.ts
  db-generate:
    description: Generate migrations files after a schema change.
    command: drizzle-kit generate
  type-cf:
    command: wrangler types
    inputs:
      - wrangler.jsonc
    outputs:
      - worker-configuration.d.ts
  container-build:
    command: tsdown
    deps: ["^:build"]
    inputs:
      - container/
      - tsdown.config.ts
    outputs:
      - output/
  container-start:
    command: bun run container/index.ts
    deps: ["^:build"]
    preset: "server"
  benchmark:
    command: bun run scripts/compile-benchmark.ts
  build-cache:
    script: ./compile-and-create.sh
    deps: ["contracts:build"]
    outputs:
      - cache/
      - public/cdn-cgi/assets/
  deploy:
    command: wrangler deploy
    deps: ["^:build"]
  deploy-preview:
    command: wrangler versions upload
    deps: ["^:build"]
  lint:
    command: biome check --formatter-enabled=false
    inputs:
      - "@group(sources)"
      - "@group(tests)"
      - "@group(container)"
  lint-fix:
    command: biome check --formatter-enabled=false --write
    inputs:
      - "@group(sources)"
      - "@group(tests)"
      - "@group(container)"
